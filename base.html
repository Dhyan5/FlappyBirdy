<!DOCTYPE html>
<html>
<head>
    <title>Flappy Bird - Leaderboard Edition</title>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #4ec0ca; font-family: 'Segoe UI', sans-serif;
        }
        canvas { display: block; }
        #ui {
            position: absolute; top: 40px; width: 100%;
            text-align: center; color: white; font-size: 52px;
            pointer-events: none; text-shadow: 3px 3px 10px rgba(0,0,0,0.7);
            z-index: 10; font-weight: 900;
        }
        /* Hidden high-score helper for the UI */
        #highScoreDisplay { font-size: 24px; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="scoreVal">0</div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('scoreVal');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- Assets ---
        const birdImg = new Image(); birdImg.src = 'bird.png'; 
        const bgImg = new Image(); bgImg.src = 'background.png'; 
        const pillarDownImg = new Image(); pillarDownImg.src = 'pillardown.svg'; 
        const pillarUpImg = new Image(); pillarUpImg.src = 'pillarup.svg'; 
        
        const bgMusic = new Audio('background.mp3');
        bgMusic.loop = true;
        bgMusic.volume = 0.6;

        const hitSound = new Audio('game audio.mp3');

        // --- Constants ---
        const GRAVITY = 0.35;
        const JUMP = -7.5;
        const PIPE_SPEED = 4;
        const PIPE_GAP = 260; 
        const PIPE_WIDTH = 90;
        const BIRD_SIZE = 65; 

        // --- Variables ---
        let bird, pipes, score, frame, gameOver, gameStarted, bgX;
        let leaderboard = JSON.parse(localStorage.getItem('flappyLeaderboard')) || [];

        function initVariables() {
            bird = { x: 120, y: canvas.height / 2, velocity: 0, rotation: 0 };
            pipes = [];
            score = 0;
            bgX = 0;
            frame = 0;
            gameOver = false;
            gameStarted = false;
            scoreElement.innerText = score;
        }

        initVariables();

        function createPipe() {
            const minHeight = 80;
            const maxHeight = canvas.height - PIPE_GAP - minHeight;
            const topHeight = Math.floor(Math.random() * (maxHeight - minHeight)) + minHeight;
            pipes.push({ x: canvas.width, top: topHeight, passed: false });
        }

        function updateLeaderboard(newScore) {
            if (newScore > 0) {
                leaderboard.push(newScore);
                // Sort descending and keep top 5
                leaderboard.sort((a, b) => b - a);
                leaderboard = leaderboard.slice(0, 5);
                localStorage.setItem('flappyLeaderboard', JSON.stringify(leaderboard));
            }
        }

        function endGame() {
            if (!gameOver) {
                gameOver = true;
                bgMusic.pause();
                hitSound.play();
                updateLeaderboard(score);
            }
        }

        function resetGame() {
            initVariables();
            gameStarted = true;
            bgMusic.currentTime = 0;
            bgMusic.play();
            loop();
        }

        function update() {
            if (gameOver || !gameStarted) return;

            bgX -= 1.5;
            if (bgX <= -canvas.width) bgX = 0;

            bird.velocity += GRAVITY;
            bird.y += bird.velocity;
            bird.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 8, bird.velocity * 0.08));

            if (bird.y + BIRD_SIZE > canvas.height || bird.y < 0) endGame();

            if (frame % 100 === 0) createPipe();

            pipes.forEach(pipe => {
                pipe.x -= PIPE_SPEED;
                if (bird.x + 10 < pipe.x + PIPE_WIDTH && bird.x + BIRD_SIZE - 10 > pipe.x) {
                    if (bird.y + 10 < pipe.top || bird.y + BIRD_SIZE - 10 > pipe.top + PIPE_GAP) endGame();
                }
                if (!pipe.passed && pipe.x < bird.x) {
                    score++;
                    scoreElement.innerText = score;
                    pipe.passed = true;
                }
            });

            pipes = pipes.filter(p => p.x > -PIPE_WIDTH);
            frame++;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Background
            if (bgImg.complete) {
                ctx.drawImage(bgImg, bgX, 0, canvas.width, canvas.height);
                ctx.drawImage(bgImg, bgX + canvas.width, 0, canvas.width, canvas.height);
            }

            // Pipes
            pipes.forEach(pipe => {
                if (pillarDownImg.complete) {
                    ctx.drawImage(pillarDownImg, pipe.x, 0, PIPE_WIDTH, pipe.top);
                    ctx.drawImage(pillarUpImg, pipe.x, pipe.top + PIPE_GAP, PIPE_WIDTH, canvas.height - (pipe.top + PIPE_GAP));
                }
            });

            // Square Bird
            ctx.save();
            ctx.translate(bird.x + BIRD_SIZE/2, bird.y + BIRD_SIZE/2);
            ctx.rotate(bird.rotation);
            ctx.shadowBlur = 15;
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            if (birdImg.complete) {
                ctx.drawImage(birdImg, -BIRD_SIZE/2, -BIRD_SIZE/2, BIRD_SIZE, BIRD_SIZE);
            } else {
                ctx.fillStyle = "yellow";
                ctx.fillRect(-BIRD_SIZE/2, -BIRD_SIZE/2, BIRD_SIZE, BIRD_SIZE);
            }
            ctx.restore();

            // Overlays
            if (!gameStarted) {
                drawOverlay("READY?", "CLICK TO FLY", false);
            } else if (gameOver) {
                drawOverlay("GAME OVER", "CLICK TO RESTART", true);
            }
        }

        function drawOverlay(title, subtitle, showLeaderboard) {
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(0,0, canvas.width, canvas.height);
            
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.shadowBlur = 0;

            // Title
            ctx.font = "bold 60px Arial";
            ctx.fillText(title, canvas.width/2, canvas.height/2 - 120);

            // Current Score
            if(showLeaderboard) {
                ctx.font = "bold 30px Arial";
                ctx.fillText("Your Score: " + score, canvas.width/2, canvas.height/2 - 70);
                
                // Leaderboard Box
                ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
                ctx.fillRect(canvas.width/2 - 100, canvas.height/2 - 50, 200, 180);
                
                ctx.fillStyle = "white";
                ctx.font = "bold 24px Arial";
                ctx.fillText("LEADERBOARD", canvas.width/2, canvas.height/2 - 20);
                
                ctx.font = "20px Arial";
                leaderboard.forEach((s, i) => {
                    ctx.fillText(`#${i+1} . . . . . . . ${s}`, canvas.width/2, canvas.height/2 + 20 + (i * 25));
                });
            }

            // Subtitle
            ctx.font = "italic 24px Arial";
            ctx.fillText(subtitle, canvas.width/2, canvas.height/2 + 180);
        }

        function loop() {
            update();
            draw();
            if (!gameOver) requestAnimationFrame(loop);
        }

        function handleInput(e) {
            if (e.type === 'keydown' && e.code !== 'Space') return;
            if (!gameStarted || gameOver) {
                resetGame();
            } else {
                bird.velocity = JUMP;
            }
        }

        window.addEventListener('mousedown', handleInput);
        window.addEventListener('keydown', handleInput);
        draw();
    </script>
</body>
</html>
